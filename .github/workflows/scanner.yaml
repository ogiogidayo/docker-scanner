name: Docker Security Scan and Comment

on:
  pull_request:
    paths:
      - Dockerfile

jobs:
  scan-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build Docker image
        run: |
          docker build -t my-docker-image .
      - name: Scan Docker image with Trivy
        run: |
          trivy image --format table --output trivy-result.txt my-docker-image
      - name: Format Trivy result
        run: |
          echo "### Docker Image Vulnerability Report" > formatted-trivy-result.md
          cat trivy-result.txt >> formatted-trivy-result.md
      - name: Post comment to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: formatted-trivy-result.md
      - name: Clean up Trivy result file
        run: rm -f trivy-result.txt formatted-trivy-result.md
